min_version: 1.6.0

pre-commit:
  parallel: true
  skip:
    - merge
    - rebase
  commands:
    format:
      glob: "config/brain/**/*.{ts,tsx,js,jsx,json}"
      root: "config/brain"
      run: npx biome check --write {staged_files}
      stage_fixed: true

    lint-syntax:
      glob: "config/brain/**/*.{ts,tsx,js,jsx}"
      root: "config/brain"
      run: npx oxlint {staged_files}

    nixfmt:
      glob: "*.nix"
      run: nixfmt --check {staged_files}

    no-shell-hooks:
      glob: "config/brain/src/hooks/*.sh"
      run: |
        if [ -n "{staged_files}" ]; then
          echo "ERROR: Shell scripts in hooks directory are banned"
          exit 1
        fi

    no-error-swallowing:
      glob: "*.nix"
      run: |
        if grep -E '\|\| true|2>/dev/null' {staged_files}; then
          echo "ERROR: Error swallowing patterns detected"
          exit 1
        fi

    no-readmes:
      glob: "config/**/*.md"
      run: |
        if echo "{staged_files}" | grep -qE "README\.md$"; then
          echo "ERROR: README.md in config/ banned. Code is self-documenting."
          exit 1
        fi

    no-version-ranges:
      glob: "**/package.json"
      run: |
        if grep -E '"[~^]' {staged_files}; then
          echo "ERROR: Semver ranges (^ or ~) banned. Use exact versions."
          exit 1
        fi

    no-sync-fs-in-hooks:
      glob: "config/brain/src/hooks/**/*.ts"
      run: |
        if grep -E 'existsSync|readFileSync|writeFileSync' {staged_files}; then
          echo "ERROR: Sync FS banned. Use @effect/platform FileSystem"
          exit 1
        fi

    no-try-catch:
      glob: "config/brain/src/**/*.ts"
      exclude: "**/*.rules.ts"
      run: |
        if grep -E '\btry\s*\{' {staged_files} | grep -v 'Effect.try'; then
          echo "ERROR: try/catch detected. Use Effect.try"
          exit 1
        fi

    # NEW: Enforce source-only exports
    no-dist-exports:
      glob: "**/package.json"
      run: |
        if grep -E '"\./(dist|build)/' {staged_files}; then
          echo "ERROR: dist exports banned. Use ./src/index.ts (source-only)"
          exit 1
        fi

    # NEW: No rewriteRelativeImportExtensions
    no-rewrite-extensions:
      glob: "**/tsconfig*.json"
      run: |
        if grep -q 'rewriteRelativeImportExtensions' {staged_files}; then
          echo "ERROR: rewriteRelativeImportExtensions banned (source-only strategy)"
          exit 1
        fi

commit-msg:
  commands:
    commitlint:
      run: bunx commitlint --config config/brain/commitlint.config.js --edit {1}
