# lefthook.base.yml - SSOT for all projects
# Consume: cp ~/dotfiles/config/quality/lefthook.base.yml lefthook.yml
min_version: 1.6.0

pre-commit:
  parallel: true
  # Skip all pre-commit hooks during merge/rebase operations
  # This is the legitimate alternative to LEFTHOOK=0 or --no-verify
  skip:
    - merge
    - rebase
  commands:
    biome:
      glob: '*.{js,ts,tsx,json}'
      run: bunx @biomejs/biome check --write {staged_files}
      stage_fixed: true

    oxlint:
      glob: '*.{js,ts,tsx,jsx}'
      run: bunx oxlint --deny correctness {staged_files}

    typecheck:
      glob: '*.{ts,tsx}'
      run: bun run typecheck

    paragon-ast:
      glob: '*.{ts,tsx}'
      run: |
        RULES_DIR="$HOME/dotfiles/config/quality/rules"
        [ ! -d "$RULES_DIR" ] && exit 0
        has_error=0

        # Filter out test files, config files, and composition roots
        # Mobile/agent apps are composition roots using XState, not Effect patterns
        filtered_files=""
        for f in {staged_files}; do
          case "$f" in
            *.test.ts|*.test.tsx|*.spec.ts|*.spec.tsx) continue ;;
            */__tests__/*|*/test/*|*/tests/*|*/e2e/*) continue ;;
            *.config.ts|*/drizzle.config.ts|*/infra/*) continue ;;
            apps/mobile/*|apps/agent/*) continue ;;
          esac
          filtered_files="$filtered_files $f"
        done

        # Exit if no non-test files to check
        [ -z "$filtered_files" ] && exit 0

        # Scan all rule categories
        for category in paragon effect effect-xstate xstate zod versions; do
          category_dir="$RULES_DIR/$category"
          [ ! -d "$category_dir" ] && continue
          for rule in "$category_dir"/*.yml; do
            [ -f "$rule" ] || continue
            # Run ast-grep and capture output
            output=$(ast-grep scan --rule "$rule" $filtered_files 2>&1 | grep -v "paragon-guard\|sig-\|ast-engine")
            if [ -n "$output" ] && echo "$output" | grep -qE "error|warning"; then
              echo "=== $category/$(basename "$rule") ==="
              echo "$output"
              has_error=1
            fi
          done
        done
        exit $has_error

    nixfmt:
      glob: '*.nix'
      run: nixfmt {staged_files}
      stage_fixed: true

commit-msg:
  commands:
    commitlint:
      run: bunx commitlint --edit {1}
