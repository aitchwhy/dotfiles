# ci-quality.yml - Reusable quality checks template
# Copy to .github/workflows/ in consuming projects
#
# Usage: cp ~/dotfiles/config/quality/ci-quality.yml .github/workflows/quality.yml

name: Quality

on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3'

      - run: bun install --frozen-lockfile --ignore-scripts

      - name: Biome Check
        run: bunx @biomejs/biome check .

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3'

      - run: bun install --frozen-lockfile --ignore-scripts

      - name: TypeScript Check
        run: bun run typecheck

  paragon:
    name: PARAGON Guards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ast-grep
        run: npm install -g @ast-grep/cli

      - name: Clone dotfiles rules
        run: git clone --depth 1 https://github.com/aitchwhy/dotfiles.git /tmp/dotfiles

      - name: Run PARAGON Rules
        run: |
          RULES_DIR="/tmp/dotfiles/config/agents/rules/ast-grep"
          has_error=0

          for rule in "$RULES_DIR"/*.yml; do
            [ -f "$rule" ] || continue
            name=$(basename "$rule" .yml)

            echo "::group::$name"
            output=$(sg scan --rule "$rule" . 2>/dev/null || true)

            if echo "$output" | grep -qE "error"; then
              echo "$output"
              has_error=1
            else
              echo "âœ“ No violations"
            fi

            echo "::endgroup::"
          done

          exit $has_error

  commitlint:
    name: Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3'

      - run: bun install --frozen-lockfile --ignore-scripts

      - name: Validate Commits
        run: |
          bunx commitlint \
            --from ${{ github.event.pull_request.base.sha }} \
            --to ${{ github.event.pull_request.head.sha }}

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3'

      - run: bun install --frozen-lockfile --ignore-scripts

      - name: Run Tests
        run: bun test
