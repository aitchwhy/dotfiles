name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.14"
  UV_VERSION: "0.5.14"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
      - run: uv run ruff check .
      - run: uv run ruff format --check .

  lint-files:
    name: File Naming Conventions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ls-lint
        run: |
          curl -sL -o ls-lint https://github.com/loeffel-io/ls-lint/releases/download/v2.3.1/ls-lint-linux
          chmod +x ls-lint
      - run: ./ls-lint

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
      - run: uv run mypy pipeline/ --ignore-missing-imports
        continue-on-error: true

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
      - run: uv run pytest tests/unit/ -v -m "unit" --junitxml=junit-unit.xml

  test-golden:
    name: Golden Dataset Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
      - run: uv run pytest tests/e2e/test_pipeline.py -v -m "golden" --junitxml=junit-golden.xml

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    env:
      DVC_REMOTE_R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      DVC_REMOTE_R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
      - name: Configure DVC
        run: |
          uv run dvc remote modify --local r2 access_key_id $DVC_REMOTE_R2_ACCESS_KEY_ID
          uv run dvc remote modify --local r2 secret_access_key $DVC_REMOTE_R2_SECRET_ACCESS_KEY
      - run: uv run dvc pull
      - run: uv run pytest tests/e2e/ -v -m "e2e"

  pipeline-smoke:
    name: Pipeline Smoke Test
    runs-on: ubuntu-latest
    env:
      DVC_REMOTE_R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      DVC_REMOTE_R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
      - name: Configure DVC
        run: |
          uv run dvc remote modify --local r2 access_key_id $DVC_REMOTE_R2_ACCESS_KEY_ID
          uv run dvc remote modify --local r2 secret_access_key $DVC_REMOTE_R2_SECRET_ACCESS_KEY
      - run: uv run dvc pull
      - run: uv run python -m pipeline.main --force
      - name: Verify outputs
        run: |
          test -L analysis || test -d analysis
          test -f analysis/manifest.json
          test -f analysis/health_profiles.json
