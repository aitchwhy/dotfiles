name: Push to Cachix

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  push-darwin:
    name: Push Darwin Closure
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: hank-dotfiles
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build and Push Darwin
        run: |
          echo "Building Darwin configuration..."
          nix build .#darwinConfigurations.hank-mbp-m4.system -o darwin-result

          echo "Pushing to Cachix..."
          cachix push hank-dotfiles darwin-result

  push-nixos:
    name: Push NixOS Closure
    runs-on: ubuntu-24.04-arm # Free arm64 for public repos

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup nixbuild.net
        uses: nixbuild/nixbuild-action@v21
        with:
          nixbuild_token: ${{ secrets.NIXBUILD_TOKEN }}

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: hank-dotfiles
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build NixOS (via nixbuild.net)
        run: |
          echo "Building NixOS configuration via nixbuild.net..."
          nix build .#nixosConfigurations.cloud.config.system.build.toplevel \
            --store ssh-ng://eu.nixbuild.net \
            --eval-store auto \
            --builders "" \
            -o nixos-result

      - name: Push to Cachix
        run: |
          echo "Pushing NixOS closure to Cachix..."
          cachix push hank-dotfiles nixos-result
