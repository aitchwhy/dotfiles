name: Agent/Skill Validation

on:
  pull_request:
    paths:
      - 'config/agents/agents/**'
      - 'config/agents/skills/**'
      - 'config/quality/src/agents/**'
      - '.github/workflows/agents.yml'
  push:
    branches: [main]
    paths:
      - 'config/agents/agents/**'
      - 'config/agents/skills/**'
      - 'config/quality/src/agents/**'
      - '.github/workflows/agents.yml'

jobs:
  validate-agents:
    name: Validate Agent Definitions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Agent Files
        run: |
          echo "Validating agent definitions..."
          for agent in config/agents/agents/*.md; do
            if [ -f "$agent" ]; then
              echo "Checking: $agent"
              grep -q "^name:" "$agent" || { echo "Missing 'name:' in $agent"; exit 1; }
              grep -q "^description:" "$agent" || { echo "Missing 'description:' in $agent"; exit 1; }
              echo "  ✓ $agent"
            fi
          done
          echo "All agent definitions valid."

      - name: Validate Skill Files
        run: |
          echo "Validating skill definitions..."
          for skill in config/agents/skills/*/; do
            if [ -d "$skill" ]; then
              echo "Checking: $skill"
              test -f "$skill/SKILL.md" || { echo "Missing SKILL.md in $skill"; exit 1; }
              echo "  ✓ $skill"
            fi
          done
          echo "All skill definitions valid."

  context-detector:
    name: Context Detector Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: config/quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Type Check
        run: bun run typecheck

      - name: Run Context Detector Tests
        run: bun test context-detector

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [validate-agents, context-detector]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Report
        run: |
          echo "## Agent/Skill Coverage Report"
          echo ""
          echo "| Category | Count |"
          echo "|----------|-------|"
          echo "| Agents | $(ls config/agents/agents/*.md 2>/dev/null | wc -l) |"
          echo "| Skills | $(ls -d config/agents/skills/*/ 2>/dev/null | wc -l) |"
          echo "| Trigger Rules | $(grep -c 'id:' config/quality/src/agents/trigger-registry.ts || echo 0) |"
