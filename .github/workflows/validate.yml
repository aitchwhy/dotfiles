name: Validate PR

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# SSOT: Define paths once, reference everywhere
env:
  QUALITY_DIR: config/quality

jobs:
  quality-tests:
    name: Quality System Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.QUALITY_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun run test

      - name: Validate artifacts
        run: bun run validate

  mcp-smoke-tests:
    name: MCP Server Smoke Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node (for npx)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Python (for uvx)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Build MCP test harness
        run: |
          cat > /tmp/mcp-smoke.ts << 'EOF'
          import { spawn } from 'bun';
          import { setTimeout } from 'timers/promises';

          interface McpServer {
            name: string;
            cmd: string[];
            env?: Record<string, string | undefined>;
            skip?: boolean;
          }

          const MCP_SERVERS: McpServer[] = [
            { name: 'repomix', cmd: ['npx', '-y', 'repomix', '--mcp'] },
            { name: 'fetch', cmd: ['uvx', 'mcp-server-fetch'] },
            {
              name: 'github',
              cmd: ['npx', '-y', '@modelcontextprotocol/server-github'],
              env: { GITHUB_PERSONAL_ACCESS_TOKEN: process.env.GITHUB_TOKEN },
            },
          ];

          let passed = 0;
          let failed = 0;

          for (const server of MCP_SERVERS) {
            if (server.skip) {
              console.log(`⏭️  ${server.name} (skipped)`);
              continue;
            }

            console.log(`Testing ${server.name}...`);
            try {
              const proc = spawn({
                cmd: server.cmd,
                env: { ...process.env, ...server.env },
                stdout: 'pipe',
                stderr: 'pipe',
              });

              // Give it 8s to start
              await setTimeout(8000);

              // Check if still running (good) or crashed with error (bad)
              // Note: exitCode 0 means clean exit, null means still running
              if (proc.exitCode === null) {
                // Still running - success
                console.log(`✅ ${server.name} started successfully`);
                passed++;
              } else if (proc.exitCode === 0) {
                // Clean exit - some MCP servers exit cleanly when idle
                console.log(`✅ ${server.name} exited cleanly`);
                passed++;
              } else {
                console.error(`❌ ${server.name} crashed with code ${proc.exitCode}`);
                failed++;
              }
              proc.kill();
            } catch (err) {
              console.error(`❌ ${server.name} failed to start: ${err}`);
              failed++;
            }
          }

          console.log(`\nResults: ${passed} passed, ${failed} failed`);
          if (failed > 0) {
            process.exit(1);
          }
          EOF

      - name: Run MCP smoke tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run /tmp/mcp-smoke.ts

  nix-check:
    name: Nix Flake Check (Local)
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check Flake (Eval Only)
        run: nix flake check --no-build

  config-validate:
    name: Validate Configs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Modern CLI Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep fd-find

      - name: Validate JSON Files
        run: |
          echo "Validating JSON files..."
          fdfind -e json --exclude node_modules --exclude .git | while read file; do
            if [[ "$file" == *cursor* ]] || [[ "$file" == *vscode* ]]; then
              echo "Skipping JSONC: $file"
              continue
            fi
            echo "Checking: $file"
            python3 -m json.tool "$file" > /dev/null || { echo "Invalid JSON: $file"; exit 1; }
          done

      - name: Validate YAML Files
        run: |
          echo "Validating YAML files..."
          sudo apt-get install -y python3-yaml
          fdfind -e yaml -e yml | while read file; do
            echo "Checking: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || { echo "Invalid YAML: $file"; exit 1; }
          done
