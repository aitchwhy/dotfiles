name: Validate PR

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  quality-tests:
    name: Quality System Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: config/quality
        run: bun install --frozen-lockfile

      - name: Run tests
        working-directory: config/quality
        run: bun test

      - name: Validate artifacts
        working-directory: config/quality
        run: bun run validate

  mcp-smoke-tests:
    name: MCP Server Smoke Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node (for npx)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Python (for uvx)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Build MCP test harness
        run: |
          cat > /tmp/mcp-smoke.ts << 'EOF'
          import { spawn } from 'bun';
          import { setTimeout } from 'timers/promises';

          interface McpServer {
            name: string;
            cmd: string[];
            env?: Record<string, string | undefined>;
            skip?: boolean;
          }

          const MCP_SERVERS: McpServer[] = [
            { name: 'repomix', cmd: ['npx', '-y', 'repomix', '--mcp'] },
            { name: 'fetch', cmd: ['uvx', 'mcp-server-fetch'] },
            {
              name: 'github',
              cmd: ['npx', '-y', '@modelcontextprotocol/server-github'],
              env: { GITHUB_PERSONAL_ACCESS_TOKEN: process.env.GITHUB_TOKEN },
            },
          ];

          let passed = 0;
          let failed = 0;

          for (const server of MCP_SERVERS) {
            if (server.skip) {
              console.log(`⏭️  ${server.name} (skipped)`);
              continue;
            }

            console.log(`Testing ${server.name}...`);
            try {
              const proc = spawn({
                cmd: server.cmd,
                env: { ...process.env, ...server.env },
                stdout: 'pipe',
                stderr: 'pipe',
              });

              // Give it 8s to start
              await setTimeout(8000);

              // Check if still running (good) or crashed (bad)
              if (proc.exitCode !== null) {
                console.error(`❌ ${server.name} crashed with code ${proc.exitCode}`);
                failed++;
              } else {
                console.log(`✅ ${server.name} started successfully`);
                passed++;
              }
              proc.kill();
            } catch (err) {
              console.error(`❌ ${server.name} failed to start: ${err}`);
              failed++;
            }
          }

          console.log(`\nResults: ${passed} passed, ${failed} failed`);
          if (failed > 0) {
            process.exit(1);
          }
          EOF

      - name: Run MCP smoke tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run /tmp/mcp-smoke.ts

  nix-check:
    name: Nix Flake Check (Local)
    runs-on: ubuntu-24.04-arm # Free arm64 for public repos

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check Flake (Eval Only)
        run: nix flake check --no-build

  config-validate:
    name: Validate Configs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Modern CLI Tools
        run: |
          # Install ripgrep, fd-find (modern Rust alternatives)
          sudo apt-get update
          sudo apt-get install -y ripgrep fd-find

      - name: Validate JSON Files
        run: |
          echo "Validating JSON files..."
          # Use fd (fdfind on Ubuntu) instead of find
          fdfind -e json --exclude node_modules --exclude .git | while read file; do
            # Skip JSONC files in cursor/vscode directories
            if [[ "$file" == *cursor* ]] || [[ "$file" == *vscode* ]]; then
              echo "Skipping JSONC: $file"
              continue
            fi
            echo "Checking: $file"
            python3 -m json.tool "$file" > /dev/null || { echo "Invalid JSON: $file"; exit 1; }
          done

      - name: Validate YAML Files
        run: |
          echo "Validating YAML files..."
          pip install pyyaml
          # Use fd (fdfind on Ubuntu) instead of find
          fdfind -e yaml -e yml | while read file; do
            echo "Checking: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || { echo "Invalid YAML: $file"; exit 1; }
          done

  claude-config:
    name: Claude Config Cross-Reference
    runs-on: ubuntu-latest
    continue-on-error: true # Skills cross-reference is tech debt for later

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Modern CLI Tools
        run: |
          # Install ripgrep, fd-find, eza (modern Rust alternatives)
          sudo apt-get update
          sudo apt-get install -y ripgrep fd-find
          wget -qO- https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz | sudo tar xz -C /usr/local/bin

      - name: Skills Cross-Reference Validation
        run: |
          echo "═══ Test 1: Skills Cross-Reference ═══"

          # Get skills defined in directory (modern: eza)
          SKILLS_DIR=$(eza --oneline config/agents/skills/ | sort)
          SKILLS_DIR_COUNT=$(echo "$SKILLS_DIR" | wc -l | tr -d ' ')

          # Get skills symlinked in agents.nix (modern: rg)
          SKILLS_NIX=$(rg '\.claude/skills/' config/agents/nix/agents.nix | \
            sed -E 's/.*\.claude\/skills\/([a-z0-9-]+)".*/\1/' | sort | uniq)
          SKILLS_NIX_COUNT=$(echo "$SKILLS_NIX" | wc -l | tr -d ' ')

          echo "Skills in directory: $SKILLS_DIR_COUNT"
          echo "Skills symlinked in agents.nix: $SKILLS_NIX_COUNT"

          # Find skills in directory but NOT symlinked
          MISSING_SYMLINKS=$(comm -23 <(echo "$SKILLS_DIR") <(echo "$SKILLS_NIX"))
          if [ -n "$MISSING_SYMLINKS" ]; then
            echo "ERROR: Skills in directory but NOT symlinked:"
            echo "$MISSING_SYMLINKS"
            exit 1
          fi
          echo "✓ All skills in directory are symlinked"

          # Find skills symlinked but NOT in directory (broken symlinks)
          ORPHAN_SYMLINKS=$(comm -13 <(echo "$SKILLS_DIR") <(echo "$SKILLS_NIX"))
          if [ -n "$ORPHAN_SYMLINKS" ]; then
            echo "ERROR: Broken symlinks (skill directory missing):"
            echo "$ORPHAN_SYMLINKS"
            exit 1
          fi
          echo "✓ No orphan symlinks"

          # Exact count match
          if [ "$SKILLS_DIR_COUNT" -ne "$SKILLS_NIX_COUNT" ]; then
            echo "ERROR: Skill count mismatch: directory=$SKILLS_DIR_COUNT, symlinked=$SKILLS_NIX_COUNT"
            exit 1
          fi
          echo "✓ Skill counts match: $SKILLS_DIR_COUNT"

      - name: MCP Servers Validation
        run: |
          echo "═══ Test 2: MCP Servers Validation ═══"

          # Extract MCP server names from claude.nix (portable sed)
          MCP_SERVERS=$(awk '/mcpServerDefs = \{/,/^  \};/' modules/home/apps/claude.nix | \
            sed -n '/^    [a-z].*= {$/p' | sed -E 's/^    ([a-z0-9-]+) =.*/\1/' | sort)
          MCP_COUNT=$(echo "$MCP_SERVERS" | wc -l | tr -d ' ')

          echo "MCP servers defined: $MCP_COUNT"
          echo "$MCP_SERVERS"

          # Validate required servers exist
          for server in memory context7 fetch repomix github; do
            # Use rg instead of grep
            if echo "$MCP_SERVERS" | rg -q "^$server$"; then
              echo "✓ Required server: $server"
            else
              echo "ERROR: Required MCP server MISSING: $server"
              exit 1
            fi
          done

      - name: Settings JSON Validation
        run: |
          echo "═══ Test 3: Settings JSON Validation ═══"

          # Validate all JSON files
          for json in config/agents/settings/*.json; do
            if [ -f "$json" ]; then
              python3 -m json.tool "$json" > /dev/null || { echo "ERROR: Invalid JSON: $json"; exit 1; }
              echo "✓ $json"
            fi
          done

          # Check required fields in claude-code.json
          SETTINGS="config/agents/settings/claude-code.json"
          python3 -c "import json; d=json.load(open('$SETTINGS')); assert 'hooks' in d" || { echo "ERROR: hooks field missing"; exit 1; }
          python3 -c "import json; d=json.load(open('$SETTINGS')); assert 'permissions' in d" || { echo "ERROR: permissions field missing"; exit 1; }
          echo "✓ Required fields present in claude-code.json"

      - name: Hook Files Validation
        run: |
          echo "═══ Test 4: Hook Files Validation ═══"

          # Extract hook files referenced in settings
          SETTINGS="config/agents/settings/claude-code.json"
          REFERENCED_HOOKS=$(python3 -c "
          import json
          import re
          d = json.load(open('$SETTINGS'))
          hooks_str = json.dumps(d.get('hooks', {}))
          matches = re.findall(r'hooks/([a-zA-Z0-9_-]+\.(ts|sh))', hooks_str)
          for m in sorted(set(m[0] for m in matches)):
              print(m)
          ")

          for hook in $REFERENCED_HOOKS; do
            if [ -f "config/agents/hooks/$hook" ]; then
              echo "✓ Hook exists: $hook"
            else
              echo "ERROR: Hook MISSING: $hook"
              exit 1
            fi
          done

      - name: Agent/Command Definitions
        run: |
          echo "═══ Test 5: Agent/Command Definitions ═══"

          # Validate skills have SKILL.md
          for skill in config/agents/skills/*/; do
            if [ -d "$skill" ]; then
              test -f "$skill/SKILL.md" || { echo "ERROR: Missing SKILL.md in $skill"; exit 1; }
              echo "✓ $skill"
            fi
          done

          # Validate agents have required frontmatter
          for agent in config/agents/agents/*.md; do
            if [ -f "$agent" ]; then
              # Use rg instead of grep
              rg -q "^name:" "$agent" || { echo "ERROR: Missing 'name:' in $agent"; exit 1; }
              rg -q "^description:" "$agent" || { echo "ERROR: Missing 'description:' in $agent"; exit 1; }
              echo "✓ $agent"
            fi
          done

          # Validate commands are not empty
          for cmd in config/agents/commands/*.md; do
            if [ -f "$cmd" ]; then
              [ -s "$cmd" ] || { echo "ERROR: Empty command file: $cmd"; exit 1; }
              echo "✓ $cmd"
            fi
          done

      - name: Summary
        run: |
          echo "═══ Summary ═══"
          # Use eza instead of ls
          echo "Skills:   $(eza --oneline config/agents/skills/ | wc -l | tr -d ' ') defined"
          echo "Agents:   $(eza config/agents/agents/*.md 2>/dev/null | wc -l | tr -d ' ') definitions"
          echo "Commands: $(eza config/agents/commands/*.md 2>/dev/null | wc -l | tr -d ' ') commands"
          echo "Hooks:    $(eza config/agents/hooks/*.ts config/agents/hooks/*.sh 2>/dev/null | wc -l | tr -d ' ') files"
          echo ""
          echo "All Claude config checks passed"
