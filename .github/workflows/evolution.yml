name: Weekly Evolution

on:
  schedule:
    # Monday 9am UTC (1am PST / 4am EST)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Create issue if score < 80%'
        type: boolean
        default: true

jobs:
  evolve:
    name: Run Evolution Graders
    runs-on: macos-14  # M1 runner for Apple Silicon parity

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        working-directory: config/agents/evolution
        run: bun install --frozen-lockfile

      - name: Validate Nix Flake
        run: nix flake check --no-build

      - name: Run Evolution Graders
        id: grade
        working-directory: config/agents/evolution
        run: |
          OUTPUT=$(bun run src/index.ts grade --ci 2>&1) || EXIT_CODE=$?
          echo "$OUTPUT"

          # Extract score from output (e.g., "Overall Score: 85.5%")
          SCORE=$(echo "$OUTPUT" | grep -oE 'Overall Score: [0-9]+\.[0-9]+' | grep -oE '[0-9]+\.[0-9]+' || echo "0")
          echo "score=$SCORE" >> $GITHUB_OUTPUT

          # Extract recommendation
          REC=$(echo "$OUTPUT" | grep -oE 'Recommendation: [^ ]+' | cut -d' ' -f2 || echo "UNKNOWN")
          echo "recommendation=$REC" >> $GITHUB_OUTPUT

          exit ${EXIT_CODE:-0}

      - name: Create Issue for Low Score
        if: failure() && (github.event_name == 'schedule' || inputs.create_issue)
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.grade.outputs.score }}';
            const recommendation = '${{ steps.grade.outputs.recommendation }}';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”´ Evolution Score Below Threshold: ${score}%`,
              body: `## Weekly Evolution Check Failed

            **Score**: ${score}%
            **Recommendation**: ${recommendation}
            **Threshold**: 80%

            ### Action Required

            The dotfiles health check failed. Please review the [workflow run](${runUrl}) for details.

            Common issues:
            - Nix flake check failing
            - Config files with syntax errors
            - Git hygiene issues (unstaged changes, non-conventional commits)
            - Performance regressions

            ### Commands to Run Locally

            \`\`\`bash
            cd ~/dotfiles
            nix flake check
            bun run --cwd config/agents/evolution src/index.ts grade
            \`\`\`

            ---
            *This issue was automatically created by the weekly evolution workflow.*`,
              labels: ['evolution', 'automated']
            });

      - name: Summary
        if: always()
        run: |
          echo "## Evolution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score**: ${{ steps.grade.outputs.score }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Recommendation**: ${{ steps.grade.outputs.recommendation }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… Health check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health check failed (threshold: 80%)" >> $GITHUB_STEP_SUMMARY
          fi
