name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  QUALITY_DIR: config/quality
  DOTFILES: ${{ github.workspace }}
  # SSOT: Pin Bun version (must match package.json engines)
  BUN_VERSION: '1.3.5'

jobs:
  ci:
    name: Unified CI Pipeline
    runs-on: ubuntu-24.04-arm

    # Use Bun Debian container - has proper shell support for child_process
    container:
      image: oven/bun:1.3.5-debian

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install system dependencies first - bun container is minimal
      - name: Install System Dependencies
        run: |
          apt-get update
          apt-get install -y xz-utils curl git ripgrep fd-find python3 python3-yaml

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install dependencies
        run: bun install
        working-directory: ${{ env.QUALITY_DIR }}

      - name: Run Unified CI Pipeline
        run: bun run ci
        working-directory: ${{ env.QUALITY_DIR }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOTFILES: ${{ github.workspace }}
