name: Deploy NixOS Cloud

on:
  push:
    branches: [main]
    paths:
      - 'hosts/cloud/**'
      - 'modules/nixos/**'
      - 'users/hank-linux.nix'
      - 'flake.nix'
      - 'flake.lock'
      - 'flake/nixos.nix'
      - 'flake/deploy.nix'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm manual deployment'
        required: true

jobs:
  deploy:
    name: Deploy to Cloud VM
    runs-on: ubuntu-24.04-arm # Free arm64 for public repos

    # Only run on push OR when manual deploy is confirmed
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'deploy')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup nixbuild.net
        uses: nixbuild/nixbuild-action@v21
        with:
          nixbuild_token: ${{ secrets.NIXBUILD_TOKEN }}

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CLOUD_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Add cloud host to known_hosts via Tailscale
          # The hostname 'cloud' resolves via Tailscale MagicDNS
          ssh-keyscan -H cloud >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Build NixOS Configuration
        run: |
          echo "Building NixOS configuration via nixbuild.net..."
          nix build .#nixosConfigurations.cloud.config.system.build.toplevel \
            --store ssh-ng://eu.nixbuild.net \
            --eval-store auto \
            --builders "" \
            -o nixos-result

      - name: Deploy with Colmena
        run: |
          echo "Deploying to cloud via Colmena..."
          nix run nixpkgs#colmena -- apply \
            --on cloud \
            --evaluator streaming \
            --verbose

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          ssh hank@cloud "nixos-rebuild list-generations | tail -5"
          ssh hank@cloud "systemctl is-system-running || true"

      - name: Report Success
        if: success()
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** cloud (GCP e2-standard-4)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ssh hank@cloud "nixos-rebuild list-generations | tail -3" >> $GITHUB_STEP_SUMMARY

      - name: Report Failure
        if: failure()
        run: |
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'ssh hank@cloud "sudo nixos-rebuild switch --rollback"' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
