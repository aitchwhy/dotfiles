name: Domains Tests

on:
  push:
    branches: [main]
    paths:
      - 'domains/**'
      - '.github/workflows/domains-*.yml'
  pull_request:
    branches: [main]
    paths:
      - 'domains/**'
      - '.github/workflows/domains-*.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.14"
  UV_VERSION: "0.5.14"

jobs:
  health-lint:
    name: Health - Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
        working-directory: domains/health
      - run: uv run ruff check .
        working-directory: domains/health
      - run: uv run ruff format --check .
        working-directory: domains/health

  health-test:
    name: Health - Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
        working-directory: domains/health
      - run: uv run pytest tests/unit/ -v -m "unit" --junitxml=junit-unit.xml
        working-directory: domains/health
        continue-on-error: true

  health-golden:
    name: Health - Golden Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
        working-directory: domains/health
      - run: uv run pytest tests/e2e/test_pipeline.py -v -m "golden" --junitxml=junit-golden.xml
        working-directory: domains/health

  health-e2e:
    name: Health - E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - uses: google-github-actions/setup-gcloud@v2
      - uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
      - run: uv python install ${{ env.PYTHON_VERSION }}
      - run: uv sync --dev
        working-directory: domains/health
      - run: uv run dvc pull
        working-directory: domains/health
      - run: uv run pytest tests/e2e/ -v -m "e2e"
        working-directory: domains/health
