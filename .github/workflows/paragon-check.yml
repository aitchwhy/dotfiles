name: PARAGON Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: paragon-${{ github.ref }}
  cancel-in-progress: true

jobs:
  paragon-guards:
    name: PARAGON Guard Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Guard 3: No Forbidden Files"
        run: |
          echo "Checking for forbidden files..."
          forbidden=(
            "package-lock.json"
            "yarn.lock"
            "pnpm-lock.yaml"
            ".eslintrc"
            ".prettierrc"
            "jest.config"
            "Dockerfile"
            "docker-compose.yml"
            "docker-compose.yaml"
            ".dockerignore"
          )
          found=0
          for pattern in "${forbidden[@]}"; do
            if find . -name "*$pattern*" -not -path "./.git/*" -not -path "./node_modules/*" 2>/dev/null | grep -q .; then
              echo "PARAGON Guard 3: Forbidden file pattern '$pattern' found"
              find . -name "*$pattern*" -not -path "./.git/*" -not -path "./node_modules/*"
              found=1
            fi
          done
          [[ $found -eq 0 ]] && echo "Guard 3: PASS"
          exit $found

      - name: "Guard 5: No Any Types"
        run: |
          echo "Checking for 'any' type in TypeScript..."
          if grep -rE ':\s*any\b|as\s+any\b|<any\s*>' --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude="*.d.ts" . 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 5: 'any' type detected"
            exit 1
          fi
          echo "Guard 5: PASS"

      - name: "Guard 6: No z.infer"
        run: |
          echo "Checking for z.infer in TypeScript..."
          if grep -rE 'z\.infer\s*<|z\.input\s*<|z\.output\s*<' --include="*.ts" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 6: z.infer detected"
            exit 1
          fi
          echo "Guard 6: PASS"

      - name: "Guard 7: No Mock Patterns"
        run: |
          echo "Checking for mock patterns..."
          if grep -rE 'jest\.mock\s*\(|vi\.mock\s*\(|Mock[A-Z][a-zA-Z]*Live' --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules . 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 7: Mock pattern detected"
            exit 1
          fi
          echo "Guard 7: PASS"

      - name: "Guard 13: No Assumption Language"
        run: |
          echo "Checking for assumption language..."
          if grep -rEi 'should (now )?work|should fix|this fixes|probably (works|fixed)|I think (this|it)|might (work|fix)|likely (fixed|works)' --include="*.ts" --include="*.tsx" --exclude="*.test.ts" --exclude="*.spec.ts" --exclude-dir=node_modules . 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 13: Assumption language detected"
            exit 1
          fi
          echo "Guard 13: PASS"
