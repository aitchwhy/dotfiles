name: PARAGON Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: paragon-${{ github.ref }}
  cancel-in-progress: true

jobs:
  paragon-guards:
    name: PARAGON Guard Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Modern CLI Tools
        run: |
          # Install ripgrep, fd-find, and eza (modern Rust alternatives)
          sudo apt-get update
          sudo apt-get install -y ripgrep fd-find
          # Install eza from GitHub releases
          wget -qO- https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz | sudo tar xz -C /usr/local/bin
          # Verify installations
          rg --version && fdfind --version && eza --version

      - name: "Guard 3: No Forbidden Files"
        run: |
          echo "Checking for forbidden files..."
          forbidden=(
            "package-lock.json"
            "yarn.lock"
            "bun.lock"
            "bun.lockb"
            ".eslintrc"
            ".prettierrc"
            "jest.config"
            "process-compose.yaml"
            "process-compose.yml"
          )
          found=0
          for pattern in "${forbidden[@]}"; do
            # Use fd (fdfind on Ubuntu) instead of find
            if fdfind --hidden --exclude .git --exclude node_modules "$pattern" 2>/dev/null | rg -q .; then
              echo "PARAGON Guard 3: Forbidden file pattern '$pattern' found"
              fdfind --hidden --exclude .git --exclude node_modules "$pattern"
              found=1
            fi
          done
          [[ $found -eq 0 ]] && echo "Guard 3: PASS"
          exit $found

      - name: "Guard 5: No Any Types"
        run: |
          echo "Checking for 'any' type in TypeScript..."
          # Use rg instead of grep
          if rg ':\s*any\b|as\s+any\b|<any\s*>' -t ts --glob '!*.d.ts' --glob '!node_modules/**' 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 5: 'any' type detected"
            exit 1
          fi
          echo "Guard 5: PASS"

      - name: "Guard 6: No z.infer"
        run: |
          echo "Checking for z.infer in TypeScript..."
          # Use rg instead of grep
          if rg 'z\.infer\s*<|z\.input\s*<|z\.output\s*<' -t ts --glob '!node_modules/**' 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 6: z.infer detected"
            exit 1
          fi
          echo "Guard 6: PASS"

      - name: "Guard 7: No Mock Patterns"
        run: |
          echo "Checking for mock patterns..."
          # Use rg instead of grep
          if rg 'jest\.mock\s*\(|vi\.mock\s*\(|Mock[A-Z][a-zA-Z]*Live' -t ts -t js --glob '!node_modules/**' 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 7: Mock pattern detected"
            exit 1
          fi
          echo "Guard 7: PASS"

      - name: "Guard 13: No Assumption Language"
        run: |
          echo "Checking for assumption language..."
          # Use rg instead of grep (-i for case insensitive)
          if rg -i 'should (now )?work|should fix|this fixes|probably (works|fixed)|I think (this|it)|might (work|fix)|likely (fixed|works)' \
            -t ts --glob '!*.test.ts' --glob '!*.spec.ts' --glob '!node_modules/**' 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 13: Assumption language detected"
            exit 1
          fi
          echo "Guard 13: PASS"

      - name: "Guard 26: No Console Methods"
        run: |
          echo "Checking for console.* methods..."
          # Use rg instead of grep
          if rg 'console\.(log|error|warn|debug|info)\s*\(' \
            -t ts --glob '!*.test.ts' --glob '!*.spec.ts' --glob '!node_modules/**' 2>/dev/null; then
            echo ""
            echo "PARAGON Guard 26: console.* method detected - use Effect logging"
            exit 1
          fi
          echo "Guard 26: PASS"

  paragon-cleanup:
    name: PARAGON Cleanup (Advisory)
    runs-on: ubuntu-latest
    needs: paragon-guards
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: config/agents

      - name: Run PARAGON Cleanup Analysis
        run: |
          pnpm exec tsx config/agents/hooks/paragon-cleanup.ts --mode full --json
          echo ""
          echo "Note: Cleanup is advisory. Critical violations blocked by guards job."
